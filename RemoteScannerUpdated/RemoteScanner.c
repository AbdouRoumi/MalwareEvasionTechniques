#include <windows.h>
#include <tchar.h>
#include <psapi.h>
#include <stdio.h>

void PrintProcessNameAndID(DWORD processID) {

    TCHAR szProcessName[MAX_PATH] = TEXT("<unknown>");

    // Get a handle to the process
    HANDLE hProcess = OpenProcess(PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, FALSE, processID);

    // Check if the process handle was opened successfully
    if (hProcess != NULL) {
        HMODULE hMod;
        DWORD cbNeeded;

        // Get the process name
        if (EnumProcessModules(hProcess, &hMod, sizeof(hMod), &cbNeeded)) {
            GetModuleBaseName(hProcess, hMod, szProcessName, sizeof(szProcessName) / sizeof(TCHAR));
        }

        // Print the process name and process ID
        _tprintf(TEXT("%s  (PID: %u)\n"), szProcessName, processID);

        // Close the handle to the process
        CloseHandle(hProcess);
    }
}

void PrintAllProcesses() {
    DWORD processes[1024], cbNeeded, processCount;

    // Get the list of process identifiers
    if (!EnumProcesses(processes, sizeof(processes), &cbNeeded)) {
        printf("EnumProcesses failed.\n");
        return;
    }

    // Calculate how many process IDs were returned
    processCount = cbNeeded / sizeof(DWORD);

    // Print the name and process identifier for each process
    for (unsigned int i = 0; i < processCount; i++) {
        if (processes[i] != 0) {
            PrintProcessNameAndID(processes[i]);
        }
    }
}

int main(void) {
    PrintAllProcesses();
    return 0;
}
